<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Happy 25th Birthday, Riyudi! ğŸ’•</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400;1,700&family=Cormorant+Garamond:ital,wght@0,300;0,400;0,600;1,300;1,400&family=Dancing+Script:wght@400;600;700&family=Caveat:wght@400;600;700&family=Homemade+Apple&family=Patrick+Hand&display=swap" rel="stylesheet">
<style>
:root{
  --blush:#f5c6c2;--rose:#e8a0a0;--deep-rose:#c97878;--cream:#fdf6f0;
  --warm-white:#fff9f5;--gold:#d4a574;--gold-light:#e8c9a0;
  --text-dark:#5a3e3e;--text-med:#8a6565;--text-light:#b08888;
  --petal1:#f8d7d4;--petal2:#f0b8b4;--petal4:#fce4ec;
  --env-front:#f0c4b8;--env-back:#e8b0a0;--env-flap:#d4967e;
  --env-inner:#fce8e0;--paper:#fffdf8;--journal-bg:#f7f0e6;
  --tape1:rgba(200,225,180,.55);--tape2:rgba(255,210,170,.55);
  --tape3:rgba(200,210,240,.55);--tape4:rgba(245,195,210,.55);
  --tape5:rgba(230,220,180,.55);
}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Cormorant Garamond',serif;background:var(--cream);color:var(--text-dark);min-height:100vh;overflow-x:hidden;-webkit-tap-highlight-color:transparent;user-select:none}

#bgCanvas,#fxCanvas{position:fixed;inset:0;pointer-events:none}
#bgCanvas{z-index:0}#fxCanvas{z-index:100}
#letterFxCanvas{position:fixed;inset:0;pointer-events:none;z-index:101}
.trail-heart{position:fixed;pointer-events:none;z-index:99;animation:trailF 1s ease-out forwards}
@keyframes trailF{0%{opacity:.8;transform:scale(1) translateY(0) rotate(0deg)}100%{opacity:0;transform:scale(.3) translateY(-40px) rotate(30deg)}}

.screen{display:none;min-height:100vh;position:relative;z-index:2;align-items:center;justify-content:center;flex-direction:column}
.screen.active{display:flex}.s-enter{animation:sIn .8s cubic-bezier(.16,1,.3,1) forwards}
@keyframes sIn{from{opacity:0;transform:scale(.9) translateY(40px);filter:blur(8px)}to{opacity:1;transform:none;filter:blur(0)}}

/* â•â•â•â•â•â• PW â•â•â•â•â•â• */
.pw-s{padding:24px}.pw-box{text-align:center;max-width:440px}
.pw-icon{font-size:64px;margin-bottom:12px;display:inline-block;animation:bob 3s ease-in-out infinite;filter:drop-shadow(0 8px 16px rgba(201,120,120,.25))}
@keyframes bob{0%,100%{transform:translateY(0) rotate(-2deg)}50%{transform:translateY(-12px) rotate(2deg)}}
.pw-t{font-family:'Dancing Script',cursive;font-size:3rem;margin-bottom:4px;line-height:1.2;background:linear-gradient(135deg,var(--deep-rose),var(--gold));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.pw-sub{font-size:1.1rem;color:var(--text-light);font-style:italic;margin-bottom:32px}
.pw-f{margin-bottom:20px}
.pw-f input{width:100%;padding:16px 24px;font-family:'Cormorant Garamond',serif;font-size:1.15rem;border:2px solid var(--blush);border-radius:50px;background:rgba(255,255,255,.65);color:var(--text-dark);text-align:center;outline:none;transition:all .4s;letter-spacing:.12em;backdrop-filter:blur(12px)}
.pw-f input:focus{border-color:var(--rose);box-shadow:0 0 0 4px rgba(232,160,160,.15),0 0 30px rgba(232,160,160,.2);background:rgba(255,255,255,.9)}
.pw-f input::placeholder{color:var(--text-light);letter-spacing:.05em}
.pw-btn{font-family:'Cormorant Garamond',serif;font-size:1.15rem;font-weight:600;padding:15px 48px;border:none;border-radius:50px;background:linear-gradient(135deg,var(--rose),var(--deep-rose));color:white;cursor:pointer;transition:all .3s;box-shadow:0 4px 24px rgba(201,120,120,.35);position:relative;overflow:hidden}
.pw-btn::after{content:'';position:absolute;inset:0;background:linear-gradient(135deg,transparent 30%,rgba(255,255,255,.2) 50%,transparent 70%);transform:translateX(-100%);transition:transform .6s}
.pw-btn:hover{transform:translateY(-3px);box-shadow:0 8px 32px rgba(201,120,120,.45)}
.pw-btn:hover::after{transform:translateX(100%)}
.pw-e{color:var(--deep-rose);font-style:italic;margin-top:14px;font-size:.95rem;height:20px;opacity:0;transition:all .3s;transform:translateY(-5px)}
.pw-e.show{opacity:1;transform:translateY(0)}.pw-e.shake{animation:shk .5s ease}
@keyframes shk{0%,100%{transform:translateX(0)}20%,60%{transform:translateX(-8px)}40%,80%{transform:translateX(8px)}}

/* â•â•â•â•â•â• ENVELOPE â•â•â•â•â•â• */
.env-s{padding:24px;cursor:pointer}
.env-pr{text-align:center;margin-bottom:24px;font-family:'Dancing Script',cursive;font-size:1.9rem;color:var(--deep-rose)}
.env-h{text-align:center;margin-top:18px;font-size:.9rem;color:var(--text-light);font-style:italic;opacity:0;transition:opacity .5s}
.env-h.show{opacity:1;animation:gp 2s ease-in-out infinite}
@keyframes gp{0%,100%{opacity:.9}50%{opacity:.45}}
.env-w{perspective:1200px;width:340px;height:240px}.env-3d{width:340px;height:240px;position:relative;transform-style:preserve-3d;transform:rotateX(8deg);transition:transform .6s cubic-bezier(.34,1.56,.64,1);filter:drop-shadow(0 20px 40px rgba(160,80,60,.2))}
.env-3d:hover{transform:rotateX(8deg) scale(1.02)}.env-3d.of{transform:rotateX(5deg)}.env-3d.lo{transform:rotateX(0)}
.e-bk{position:absolute;inset:0;background:linear-gradient(180deg,var(--env-back),#dba090);border-radius:14px;z-index:1}
.e-in{position:absolute;top:12px;left:12px;right:12px;bottom:12px;background:var(--env-inner);border-radius:6px;z-index:2}
.e-fl{position:absolute;top:0;left:0;right:0;height:120px;background:linear-gradient(180deg,var(--env-flap),#c8866e);z-index:5;clip-path:polygon(0 0,100% 0,50% 100%);transform-origin:top center;transition:transform .8s cubic-bezier(.4,0,.2,1);border-radius:14px 14px 0 0}.e-fl.open{transform:rotateX(180deg);z-index:0}
.e-fr{position:absolute;bottom:0;left:0;right:0;height:150px;background:linear-gradient(0deg,var(--env-front),#e8b8aa);z-index:4;clip-path:polygon(0 100%,100% 100%,100% 0,50% 65%,0 0);border-radius:0 0 14px 14px}
.e-se{position:absolute;top:calc(50% - 4px);left:50%;transform:translate(-50%,-50%);z-index:6;width:52px;height:52px;background:radial-gradient(circle at 35% 35%,#e07070,#b85050);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:22px;box-shadow:0 4px 12px rgba(160,60,60,.35),inset 0 2px 4px rgba(255,255,255,.2);transition:all .5s cubic-bezier(.34,1.56,.64,1)}.e-se.burst{transform:translate(-50%,-50%) scale(2.5) rotate(45deg);opacity:0;filter:blur(4px)}
.e-pk{position:absolute;left:28px;right:28px;height:190px;background:linear-gradient(180deg,var(--paper),#fff5ee);border-radius:8px 8px 0 0;z-index:3;bottom:26px;box-shadow:0 -4px 12px rgba(0,0,0,.04);display:flex;flex-direction:column;align-items:center;padding-top:20px;transition:transform 1s cubic-bezier(.34,1.56,.64,1)}.e-pk.risen{transform:translateY(-155px)}
.pk-l{width:60%;height:2px;background:var(--blush);border-radius:2px;margin:5px 0;opacity:0;transition:opacity .4s}.e-pk.risen .pk-l{opacity:1}.e-pk.risen .pk-l:nth-child(1){transition-delay:.5s}.e-pk.risen .pk-l:nth-child(2){transition-delay:.65s;width:75%}.e-pk.risen .pk-l:nth-child(3){transition-delay:.8s;width:50%}
.pk-h{font-size:20px;margin-top:8px;opacity:0;transition:opacity .4s .95s,transform .6s .95s;transform:scale(0)}.e-pk.risen .pk-h{opacity:1;transform:scale(1)}

/* â•â•â•â•â•â• UNFOLD â•â•â•â•â•â• */
.uf-s{padding:24px;cursor:pointer}.uf-bx{max-width:440px;width:100%;text-align:center}
.f-pr{font-family:'Dancing Script',cursive;font-size:1.7rem;color:var(--deep-rose);margin-bottom:20px}
.f-h{text-align:center;margin-top:14px;font-size:.85rem;color:var(--text-light);font-style:italic;opacity:0;transition:opacity .5s}.f-h.show{opacity:1;animation:gp 2s ease-in-out infinite}
.ori{width:300px;margin:0 auto;perspective:1000px;position:relative}
.ori-p{width:300px;height:110px;background:linear-gradient(135deg,var(--paper),#fff8f0);position:relative;transform-style:preserve-3d;transition:transform 1s cubic-bezier(.4,0,.2,1)}
.ori-t{transform-origin:bottom center;z-index:3;border-radius:10px 10px 0 0;box-shadow:0 2px 8px rgba(0,0,0,.04)}.ori-t.uf{transform:rotateX(-178deg)}
.ori-m{z-index:2}.ori-b{border-radius:0 0 10px 10px;z-index:1;box-shadow:0 8px 24px rgba(0,0,0,.07)}
.ori-d{width:300px;height:1px;background:repeating-linear-gradient(90deg,var(--blush) 0,var(--blush) 6px,transparent 6px,transparent 12px)}
.ori-fc{position:absolute;inset:0;backface-visibility:hidden;display:flex;align-items:center;justify-content:center;padding:16px}
.ori-fb{position:absolute;inset:0;backface-visibility:hidden;transform:rotateX(180deg);background:linear-gradient(135deg,var(--petal1),var(--petal4));border-radius:10px 10px 0 0;display:flex;align-items:center;justify-content:center;font-family:'Dancing Script',cursive;color:var(--deep-rose);font-size:1.2rem}
.ori-tx{font-family:'Caveat',cursive;font-size:1rem;color:var(--text-med);line-height:1.5;text-align:center}
.ori-sl{position:absolute;top:-18px;left:50%;transform:translateX(-50%);width:40px;height:40px;background:radial-gradient(circle at 35% 35%,#e07070,#b85050);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:16px;z-index:10;box-shadow:0 3px 10px rgba(160,60,60,.3);transition:all .6s cubic-bezier(.34,1.56,.64,1)}.ori-sl.burst{transform:translateX(-50%) scale(2) rotate(60deg);opacity:0;filter:blur(3px)}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SCRAPBOOK
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.sb-s{display:none;position:relative;z-index:2}.sb-s.active{display:block}
.sb-bg{
  background:
    repeating-linear-gradient(0deg,transparent,transparent 31px,rgba(200,180,160,.1) 31px,rgba(200,180,160,.1) 32px),
    linear-gradient(135deg,#f7f0e6 0%,#f2e8d8 30%,#f5ede0 60%,#f0e6d4 100%);
  min-height:100vh;
}
.sb-torn-top{height:24px;width:100%;position:relative;overflow:hidden;background:var(--cream)}
.sb-torn-top::after{content:'';position:absolute;bottom:0;left:0;right:0;height:24px;background:var(--journal-bg);clip-path:polygon(0% 60%,2% 80%,4% 55%,6% 75%,8% 50%,10% 70%,12% 45%,14% 65%,16% 50%,18% 72%,20% 48%,22% 68%,24% 42%,26% 65%,28% 48%,30% 70%,32% 45%,34% 68%,36% 50%,38% 72%,40% 46%,42% 66%,44% 42%,46% 64%,48% 48%,50% 70%,52% 44%,54% 66%,56% 50%,58% 72%,60% 46%,62% 68%,64% 44%,66% 64%,68% 48%,70% 70%,72% 42%,74% 66%,76% 50%,78% 72%,80% 46%,82% 68%,84% 44%,86% 66%,88% 48%,90% 70%,92% 45%,94% 68%,96% 50%,98% 72%,100% 55%,100% 100%,0% 100%)}

/* String lights */
.sl{position:relative;width:100%;height:55px;margin-bottom:6px;overflow:visible}
.sl-wire{position:absolute;top:0;left:5%;right:5%;height:36px;border-bottom:2px solid #c4b8a0;border-radius:0 0 50% 50%}
.sl-bulb{position:absolute;bottom:-2px;width:10px;height:14px;border-radius:0 0 50% 50%;animation:glow 2s ease-in-out infinite alternate}
@keyframes glow{0%{filter:brightness(1) drop-shadow(0 0 3px currentColor)}100%{filter:brightness(1.3) drop-shadow(0 0 8px currentColor)}}

/* Hero */
.sb-hero{text-align:center;padding:50px 20px 10px}
.sb-title{font-family:'Dancing Script',cursive;font-size:4rem;line-height:1.15;color:var(--deep-rose);display:flex;flex-wrap:wrap;justify-content:center}
.sb-title .char{display:inline-block;opacity:0;transform:translateY(60px) scale(.3) rotate(-15deg);filter:blur(8px);animation:chIn .7s cubic-bezier(.16,1,.3,1) forwards}
@keyframes chIn{to{opacity:1;transform:none;filter:blur(0)}}
.sb-title .space{width:.3em}
.sb-stars{font-size:1.2rem;color:var(--gold);letter-spacing:.5em;margin-top:6px;opacity:0;animation:fU .8s 1.8s ease forwards}
@keyframes fU{from{opacity:0;transform:translateY(15px)}to{opacity:1;transform:none}}
.sb-date{font-family:'Patrick Hand',cursive;font-size:1.1rem;color:var(--text-light);margin-top:8px;opacity:0;animation:fU .8s 2.2s ease forwards}
.sb-scroll-cue{margin-top:28px;opacity:0;animation:fU .8s 2.8s ease forwards;display:flex;flex-direction:column;align-items:center;gap:4px}
.sb-scroll-cue span{font-family:'Patrick Hand',cursive;font-size:.9rem;color:var(--text-light)}
.sb-arrow{width:18px;height:18px;border-right:2px solid var(--rose);border-bottom:2px solid var(--rose);transform:rotate(45deg);animation:abounce 1.5s ease-in-out infinite}
@keyframes abounce{0%,100%{transform:rotate(45deg) translate(0,0)}50%{transform:rotate(45deg) translate(4px,4px)}}

/* Page */
.sb-page{max-width:820px;width:100%;margin:0 auto;padding:20px 20px 40px;position:relative}

/* â”€â”€ Collage section â€” organic scattered layout â”€â”€ */
.collage{
  position:relative;width:100%;min-height:200px;margin-bottom:20px;
  opacity:0;transform:translateY(30px);
  transition:opacity .8s cubic-bezier(.16,1,.3,1),transform .8s cubic-bezier(.16,1,.3,1);
}
.collage.vis{opacity:1;transform:none}

/* â”€â”€ Polaroid â”€â”€ */
.polaroid{
  background:white;position:absolute;
  box-shadow:2px 3px 14px rgba(0,0,0,.1),0 1px 3px rgba(0,0,0,.06);
  transition:transform .5s cubic-bezier(.34,1.56,.64,1),box-shadow .4s,z-index 0s;
  cursor:zoom-in;z-index:5;
}
.polaroid:hover{z-index:20!important;box-shadow:4px 8px 28px rgba(0,0,0,.18)}
.polaroid .p-inner{padding:8px 8px 32px}
.polaroid.sz-s .p-inner{padding:6px 6px 26px}
.polaroid.sz-l .p-inner{padding:10px 10px 38px}
.ph-img{width:100%;display:block;position:relative;overflow:hidden;background:#f5f5f5}
.ph-img img{width:100%;height:auto;display:block}
.ph-img:not(:has(img)){aspect-ratio:1} /* Keep square only for placeholders */
.ph-grad{position:absolute;inset:0}
.ph-icon{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-size:2rem;opacity:.45}
.polaroid-cap{
  font-family:'Homemade Apple',cursive;font-size:.6rem;color:var(--text-med);
  text-align:center;position:absolute;bottom:8px;left:8px;right:8px;line-height:1.3;
}
.polaroid.sz-s .polaroid-cap{font-size:.5rem;bottom:6px}
.polaroid.sz-l .polaroid-cap{font-size:.65rem;bottom:10px}

/* Size classes */
.polaroid.sz-s{width:120px}
.polaroid.sz-m{width:160px}
.polaroid.sz-l{width:200px}

/* â”€â”€ Washi tape â”€â”€ */
.washi{
  position:absolute;height:18px;width:70px;border-radius:1px;z-index:25;
  opacity:.8;pointer-events:none;
  background-image:repeating-linear-gradient(90deg,transparent,transparent 3px,rgba(255,255,255,.18) 3px,rgba(255,255,255,.18) 6px);
}

/* â”€â”€ Push pin â”€â”€ */
.pushpin{
  position:absolute;width:16px;height:16px;border-radius:50%;z-index:26;
  box-shadow:0 2px 4px rgba(0,0,0,.2),inset 0 -1px 2px rgba(0,0,0,.15),inset 0 2px 3px rgba(255,255,255,.3);
  pointer-events:none;
}

/* â”€â”€ Paper clip â”€â”€ */
.paperclip{
  position:absolute;z-index:26;width:20px;height:40px;pointer-events:none;
  border:2px solid #c4b8a0;border-radius:10px 10px 0 0;
  border-bottom:none;opacity:.7;
}

/* â”€â”€ Note card / sticky note â”€â”€ */
.note-card{
  background:var(--paper);padding:24px 22px;position:relative;
  box-shadow:1px 2px 8px rgba(0,0,0,.05);
  border-left:3px solid var(--blush);
}
.note-card p{font-family:'Patrick Hand',cursive;font-size:1.12rem;line-height:1.85;color:var(--text-dark)}

.sticky-note{
  padding:18px 16px;position:absolute;z-index:10;
  box-shadow:2px 3px 8px rgba(0,0,0,.08);
  font-family:'Caveat',cursive;font-size:.95rem;color:var(--text-dark);
  line-height:1.5;width:140px;
}
.sticky-yellow{background:linear-gradient(135deg,#fff9c4,#fff59d)}
.sticky-pink{background:linear-gradient(135deg,#fce4ec,#f8bbd0)}
.sticky-blue{background:linear-gradient(135deg,#e3f2fd,#bbdefb)}
.sticky-green{background:linear-gradient(135deg,#e8f5e9,#c8e6c9)}

/* â”€â”€ Full text block â”€â”€ */
.sb-text-block{
  background:rgba(255,255,255,.6);backdrop-filter:blur(4px);
  padding:28px 26px;border-radius:3px;position:relative;
  box-shadow:1px 2px 6px rgba(0,0,0,.03);
  border:1px solid rgba(245,198,194,.15);
  opacity:0;transform:translateY(25px);
  transition:opacity .8s ease,transform .8s ease;
}
.sb-text-block.vis{opacity:1;transform:none}
.sb-text-block p{font-family:'Patrick Hand',cursive;font-size:1.15rem;line-height:1.9;color:var(--text-dark);margin-bottom:10px}
.sb-text-block p:last-child{margin-bottom:0}

/* â”€â”€ Greeting block â”€â”€ */
.sb-greeting{
  text-align:center;padding:20px 0 10px;
  opacity:0;transform:translateY(20px);
  transition:opacity .8s ease,transform .8s ease;
}
.sb-greeting.vis{opacity:1;transform:none}
.sb-greeting-text{
  font-family:'Dancing Script',cursive;font-size:2rem;color:var(--deep-rose);
  display:inline;
}
.gr-cursor{display:inline-block;width:2px;height:1em;background:var(--deep-rose);margin-left:3px;vertical-align:text-bottom;animation:blink .7s step-end infinite}
@keyframes blink{0%,100%{opacity:1}50%{opacity:0}}
.doodle-line{display:block;margin:6px auto 0;height:8px;stroke:var(--rose);stroke-width:2;fill:none;stroke-dasharray:300;stroke-dashoffset:300;transition:stroke-dashoffset 1.2s ease .3s}
.drawn{stroke-dashoffset:0}

/* Sticker */
.sticker{position:absolute;pointer-events:none;z-index:18;animation:stickerPop .5s cubic-bezier(.34,1.56,.64,1) both;filter:drop-shadow(1px 2px 3px rgba(0,0,0,.08))}
@keyframes stickerPop{from{opacity:0;transform:scale(0) rotate(-30deg)}to{opacity:1;transform:scale(1) rotate(var(--rot,0deg))}}

/* Divider doodle */
.sb-divider{text-align:center;padding:10px 0;font-size:1.2rem;color:var(--rose);letter-spacing:.8em;opacity:.4}

/* Scattered page decorations */
.page-deco{
  position:absolute;pointer-events:none;z-index:1;
  opacity:0;transition:opacity .8s ease,transform .8s ease;
  transform:translateY(10px);
  filter:drop-shadow(1px 2px 4px rgba(0,0,0,.06));
}
.page-deco.vis{opacity:var(--deco-opacity,.4);transform:translateY(0) rotate(var(--deco-rot,0deg))}
.page-deco-inner{
  display:flex;align-items:center;justify-content:center;
  font-size:var(--deco-size,1.5rem);
  animation:decoFloat var(--deco-dur,6s) ease-in-out infinite;
  animation-delay:var(--deco-delay,0s);
}
@keyframes decoFloat{
  0%,100%{transform:translateY(0) rotate(0deg)}
  33%{transform:translateY(-4px) rotate(2deg)}
  66%{transform:translateY(2px) rotate(-1.5deg)}
}
/* Handwritten margin notes */
.margin-note{
  position:absolute;pointer-events:none;z-index:1;
  font-family:'Caveat',cursive;color:var(--text-light);
  opacity:0;transition:opacity .8s ease;
  transform:rotate(var(--note-rot,0deg));
  font-size:.9rem;white-space:nowrap;
}
.margin-note.vis{opacity:.35}

/* Sign off */
.sb-sign{text-align:center;padding:30px 20px;opacity:0;transform:translateY(20px) scale(.97);transition:all .8s cubic-bezier(.16,1,.3,1)}
.sb-sign.vis{opacity:1;transform:none}
.sb-sign-card{display:inline-block;padding:24px 40px;background:white;box-shadow:2px 3px 12px rgba(0,0,0,.06);position:relative}
.sb-signoff{font-family:'Homemade Apple',cursive;font-size:1.2rem;color:var(--deep-rose)}
.sb-sign-heart{font-size:2.5rem;margin-top:8px;display:inline-block;animation:hb 1.5s ease-in-out infinite}
@keyframes hb{0%,100%{transform:scale(1)}15%{transform:scale(1.25)}30%{transform:scale(1)}45%{transform:scale(1.15)}}

/* Heart finale */
.sb-finale{display:flex;align-items:center;justify-content:center;padding:30px 0 10px}
#heartCanvas{width:100%;max-width:400px;height:350px;display:block;margin:0 auto}

.sb-restart{text-align:center;padding:0 0 60px}
.sb-restart button{font-family:'Patrick Hand',cursive;font-size:1rem;color:var(--text-light);background:none;border:none;cursor:pointer;transition:color .3s}
.sb-restart button:hover{color:var(--deep-rose)}

/* â•â•â•â•â•â• PHOTO LIGHTBOX â•â•â•â•â•â• */
.lightbox{
  position:fixed;inset:0;z-index:200;display:none;align-items:center;justify-content:center;
  flex-direction:column;cursor:zoom-out;padding:24px;
}
.lightbox.active{display:flex}
.lb-backdrop{
  position:absolute;inset:0;background:rgba(60,40,40,.6);
  backdrop-filter:blur(16px) saturate(.7);
  opacity:0;transition:opacity .4s ease;
}
.lightbox.active .lb-backdrop{opacity:1}
.lb-content{
  position:relative;z-index:1;max-width:560px;width:90%;
  opacity:0;transform:scale(.6) rotate(-3deg) translateY(30px);
  transition:opacity .45s cubic-bezier(.16,1,.3,1),transform .45s cubic-bezier(.16,1,.3,1);
}
.lightbox.active .lb-content{opacity:1;transform:scale(1) rotate(0deg) translateY(0)}
.lb-polaroid{
  background:white;padding:14px 14px 52px;margin:0 auto;display:block;
  box-shadow:4px 6px 32px rgba(0,0,0,.2),0 0 0 1px rgba(0,0,0,.03);
}
.lb-img{width:100%;display:block;position:relative;overflow:hidden}
.lb-img.has-real-img{aspect-ratio:auto}
.lb-img:not(.has-real-img){aspect-ratio:1}
.lb-img img{width:100%;height:auto;display:block;max-height:70vh;object-fit:contain}
.lb-img .ph-grad{position:absolute;inset:0;aspect-ratio:1}
.lb-img .ph-icon{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-size:4rem;opacity:.35}
.lb-cap{
  font-family:'Homemade Apple',cursive;font-size:1rem;color:var(--text-med);
  text-align:center;margin-top:14px;position:absolute;bottom:14px;left:14px;right:14px;
}
.lb-close-hint{
  margin-top:16px;font-family:'Patrick Hand',cursive;font-size:.9rem;
  color:rgba(255,255,255,.7);text-align:center;z-index:1;
  opacity:0;transition:opacity .4s .3s;
}
.lightbox.active .lb-close-hint{opacity:1}
.lb-nav{
  position:absolute;top:50%;z-index:2;width:44px;height:44px;
  background:rgba(255,255,255,.2);backdrop-filter:blur(8px);
  border:1px solid rgba(255,255,255,.25);border-radius:50%;
  display:flex;align-items:center;justify-content:center;
  cursor:pointer;transition:all .25s;color:white;font-size:1.2rem;
  transform:translateY(-50%);
}
.lb-nav:hover{background:rgba(255,255,255,.35);transform:translateY(-50%) scale(1.1)}
.lb-prev{left:12px}
.lb-next{right:12px}
@media(max-width:600px){
  .lb-polaroid{padding:10px 10px 44px}
  .lb-cap{font-size:.85rem;bottom:12px}
  .lb-nav{width:36px;height:36px;font-size:1rem}
}

/* â•â•â•â•â•â• ADMIN â•â•â•â•â•â• */
.adm-lk{position:fixed;bottom:14px;right:18px;font-size:.7rem;color:var(--text-light);opacity:.25;cursor:pointer;z-index:10;transition:opacity .3s;font-family:'Cormorant Garamond',serif}.adm-lk:hover{opacity:.65}
.m-ov{display:none;position:fixed;inset:0;background:rgba(90,62,62,.35);backdrop-filter:blur(8px);z-index:50;align-items:center;justify-content:center}.m-ov.active{display:flex;animation:sIn .3s ease}
.modal{background:white;border-radius:20px;padding:36px 32px;max-width:380px;width:90%;text-align:center;box-shadow:0 24px 64px rgba(0,0,0,.14)}
.modal h3{font-family:'Playfair Display',serif;font-size:1.3rem;color:var(--text-dark);margin-bottom:4px}
.modal p{color:var(--text-light);font-size:.9rem;margin-bottom:18px}
.modal input{width:100%;padding:13px 16px;font-family:'Cormorant Garamond',serif;font-size:1rem;border:2px solid #f0e0dc;border-radius:12px;background:var(--warm-white);color:var(--text-dark);outline:none;text-align:center;margin-bottom:12px}
.modal input:focus{border-color:var(--rose)}
.mbtn{font-family:'Cormorant Garamond',serif;font-size:1rem;font-weight:600;padding:11px 32px;border:none;border-radius:50px;background:linear-gradient(135deg,var(--gold),var(--deep-rose));color:white;cursor:pointer}
.mcanc{font-family:'Cormorant Garamond',serif;font-size:.9rem;color:var(--text-light);background:none;border:none;cursor:pointer;margin-top:10px;display:block;margin-inline:auto}
.modal .er{color:var(--deep-rose);font-style:italic;margin-top:8px;font-size:.85rem;opacity:0;transition:opacity .3s}.modal .er.show{opacity:1}
.adm-s{padding:40px 20px;overflow-y:auto;display:none!important}
.adm-s.active{display:block!important}
.adm-p{max-width:740px;width:100%;background:white;border-radius:20px;padding:40px 36px;box-shadow:0 12px 40px rgba(0,0,0,.06);margin:0 auto}
.adm-p h2{font-family:'Playfair Display',serif;font-size:1.6rem;color:var(--text-dark);margin-bottom:4px}
.adm-p .as{color:var(--text-light);font-style:italic;margin-bottom:24px}
.fg{margin-bottom:18px}.fg label{display:block;font-weight:600;color:var(--text-med);margin-bottom:6px;font-size:.9rem}
.fg input,.fg textarea{width:100%;padding:13px 16px;font-family:'Cormorant Garamond',serif;font-size:1rem;border:2px solid #f0e0dc;border-radius:12px;background:var(--warm-white);color:var(--text-dark);outline:none;transition:border-color .3s,box-shadow .3s}
.fg input:focus,.fg textarea:focus{border-color:var(--rose);box-shadow:0 0 12px rgba(232,160,160,.2)}
.fg textarea{min-height:200px;resize:vertical;line-height:1.7}
.aa{display:flex;gap:10px;margin-top:24px;flex-wrap:wrap}
.sbtn{font-family:'Cormorant Garamond',serif;font-size:1rem;font-weight:600;padding:12px 32px;border:none;border-radius:50px;background:linear-gradient(135deg,var(--gold),var(--deep-rose));color:white;cursor:pointer;transition:all .3s;box-shadow:0 4px 16px rgba(212,165,116,.3)}.sbtn:hover{transform:translateY(-2px)}
.pbtn,.bbtn{font-family:'Cormorant Garamond',serif;font-size:1rem;padding:12px 24px;border:2px solid var(--blush);border-radius:50px;background:transparent;color:var(--text-med);cursor:pointer;transition:all .3s}
.pbtn:hover,.bbtn:hover{background:var(--petal4);border-color:var(--rose)}
.sfb{width:100%;text-align:center;margin-top:10px;font-style:italic;color:var(--deep-rose);font-size:.9rem;opacity:0;transition:opacity .4s}.sfb.show{opacity:1}

/* Admin tabs */
.adm-tabs{display:flex;gap:0;margin-bottom:24px;border-bottom:2px solid #f0e0dc}
.adm-tab{font-family:'Cormorant Garamond',serif;font-size:1rem;font-weight:600;padding:10px 20px;border:none;background:none;color:var(--text-light);cursor:pointer;transition:all .3s;border-bottom:2px solid transparent;margin-bottom:-2px}
.adm-tab.active{color:var(--deep-rose);border-bottom-color:var(--deep-rose)}
.adm-tab:hover{color:var(--text-med)}
.adm-panel{display:none}.adm-panel.active{display:block}

/* Photo grid */
.photo-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(170px,1fr));gap:16px}
.photo-slot{background:var(--warm-white);border:2px dashed #e0d0cc;border-radius:12px;padding:12px;text-align:center;position:relative;transition:border-color .3s}
.photo-slot.has-img{border-style:solid;border-color:var(--blush)}
.photo-slot-preview{width:100%;aspect-ratio:1;border-radius:6px;overflow:hidden;margin-bottom:8px;position:relative;background:#f5f0eb;display:flex;align-items:center;justify-content:center}
.photo-slot-preview img{width:100%;height:100%;object-fit:cover}
.photo-slot-preview .ph-placeholder{font-size:2.5rem;opacity:.3}
.photo-slot-upload{display:block;width:100%;padding:8px;font-family:'Patrick Hand',cursive;font-size:.85rem;color:var(--deep-rose);background:white;border:1.5px solid var(--blush);border-radius:8px;cursor:pointer;transition:all .3s;margin-bottom:6px}
.photo-slot-upload:hover{background:var(--petal4);border-color:var(--rose)}
.photo-slot input[type="file"]{display:none}
.photo-slot-cap{width:100%;padding:7px 10px;font-family:'Caveat',cursive;font-size:.9rem;border:1.5px solid #e8ddd6;border-radius:8px;background:white;color:var(--text-dark);outline:none;text-align:center;transition:border-color .3s}
.photo-slot-cap:focus{border-color:var(--rose)}
.photo-slot-remove{position:absolute;top:6px;right:6px;width:22px;height:22px;border-radius:50%;background:rgba(201,120,120,.8);color:white;border:none;font-size:.7rem;cursor:pointer;display:none;align-items:center;justify-content:center;line-height:1;transition:background .2s}
.photo-slot.has-img .photo-slot-remove{display:flex}
.photo-slot-remove:hover{background:var(--deep-rose)}
.photo-slot-num{font-family:'Patrick Hand',cursive;font-size:.75rem;color:var(--text-light);margin-bottom:4px}
.photo-add-btn{border:2px dashed var(--blush);border-radius:12px;padding:24px;text-align:center;cursor:pointer;transition:all .3s;background:transparent;width:100%;font-family:'Patrick Hand',cursive;font-size:1rem;color:var(--text-light)}
.photo-add-btn:hover{border-color:var(--rose);background:rgba(252,228,236,.2);color:var(--deep-rose)}

@media(max-width:700px){
  .sb-title{font-size:2.8rem!important}
  .sb-page{padding:10px 10px 40px}
  .polaroid.sz-s{width:90px!important}.polaroid.sz-m{width:120px!important}.polaroid.sz-l{width:155px!important}
  .sticky-note{width:110px;font-size:.8rem;padding:12px 10px}
  .sb-text-block{padding:20px 16px}.sb-text-block p{font-size:1.02rem}
  .note-card{padding:18px 14px}.note-card p{font-size:1rem}
  .collage{min-height:160px}
  .adm-p{padding:24px 18px}
  .photo-grid{grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:12px}
}
</style>
</head>
<body>
<canvas id="bgCanvas"></canvas><canvas id="fxCanvas"></canvas><canvas id="letterFxCanvas"></canvas>

<!-- S1 -->
<div class="screen pw-s active s-enter" id="S_pw"><div class="pw-box"><div class="pw-icon">ğŸ’Œ</div><h1 class="pw-t">A Letter For Riyudi</h1><p class="pw-sub">This is only for you, Riyudi patootie...</p><div class="pw-f"><input type="password" id="pwIn" placeholder="Enter the secret word" autocomplete="off"></div><button class="pw-btn" onclick="tryUnlock()">Open My Heart ğŸ’•</button><p class="pw-e" id="pwErr">That's not it... try again ğŸ’«</p></div></div>
<!-- S2 -->
<div class="screen env-s" id="S_env" onclick="envClick()"><p class="env-pr" id="envPr">Riyu, tap to open your letter ğŸ’Œ</p><div class="env-w"><div class="env-3d" id="env3d"><div class="e-bk"></div><div class="e-in"></div><div class="e-pk" id="ePk"><div class="pk-l"></div><div class="pk-l"></div><div class="pk-l"></div><div class="pk-h">ğŸ’•</div></div><div class="e-fl" id="eFl"></div><div class="e-fr"></div><div class="e-se" id="eSe">ğŸ’—</div></div></div><p class="env-h" id="envH"></p></div>
<!-- S3 -->
<div class="screen uf-s" id="S_uf" onclick="ufClick()"><div class="uf-bx"><p class="f-pr" id="fPr">Riyu, tap to unfold your letter âœ¨</p><div class="ori"><div class="ori-sl" id="oSl">ğŸ’—</div><div class="ori-p ori-t" id="oT"><div class="ori-fc"><span class="ori-tx">a little note<br>written just for Riyu</span></div><div class="ori-fb">with love ğŸ’•</div></div><div class="ori-d"></div><div class="ori-p ori-m"><div class="ori-fc"><span class="ori-tx">every word comes<br>straight from my heart</span></div></div><div class="ori-d"></div><div class="ori-p ori-b"><div class="ori-fc"><span class="ori-tx">I hope it makes<br>you smile today, Riyu ğŸŒ¸</span></div></div></div><p class="f-h" id="fH">tap anywhere</p></div></div>

<!-- S4: SCRAPBOOK -->
<div class="screen sb-s" id="S_sb">
  <div class="sb-bg">
    <div class="sb-torn-top"></div>
    <div class="sl" id="sL"><div class="sl-wire"></div></div>
    <div class="sb-hero"><div class="sb-title" id="sbTitle"></div><div class="sb-stars">âœ¦ âœ¦ âœ¦</div><p class="sb-date" id="sbDate"></p><div class="sb-scroll-cue"><span>scroll down to read</span><div class="sb-arrow"></div></div></div>
    <div class="sb-page" id="sbPage"></div>
    <div class="sb-sign" id="sbSign"><div class="sb-sign-card"><div class="sb-signoff" id="sbSignOff"></div><div class="sb-sign-heart">â¤ï¸</div></div></div>
    <div class="sb-finale" id="sbFinale"><canvas id="heartCanvas" width="400" height="350"></canvas></div>
    <div class="sb-restart">
      <!-- Journey link commented out for now
      <a href="journey.html" style="display:inline-block;font-family:'Dancing Script',cursive;font-size:1.3rem;color:white;background:linear-gradient(135deg,var(--rose),var(--deep-rose));padding:16px 40px;border-radius:50px;text-decoration:none;box-shadow:0 4px 24px rgba(201,120,120,.35);transition:all .3s;margin-bottom:16px" onmouseover="this.style.transform='translateY(-3px)';this.style.boxShadow='0 8px 32px rgba(201,120,120,.45)'" onmouseout="this.style.transform='';this.style.boxShadow='0 4px 24px rgba(201,120,120,.35)'">Continue Your Birthday Journey âœ¨</a>
      <br>
      -->
      <button onclick="restart()">â† start over</button>
    </div>
  </div>
</div>

<!-- PHOTO LIGHTBOX -->
<div class="lightbox" id="lightbox" onclick="closeLB(event)">
  <div class="lb-backdrop"></div>
  <div class="lb-content">
    <div class="lb-polaroid">
      <div class="lb-img" id="lbImg"></div>
      <div class="lb-cap" id="lbCap"></div>
    </div>
  </div>
  <div class="lb-nav lb-prev" onclick="navLB(-1,event)">â€¹</div>
  <div class="lb-nav lb-next" onclick="navLB(1,event)">â€º</div>
  <div class="lb-close-hint"><span id="lbCounter"></span> Â· tap anywhere to close</div>
</div>

<!-- ADMIN -->
<div class="screen adm-s" id="S_adm"><div class="adm-p">
  <h2>âœï¸ Edit Your Scrapbook</h2><p class="as">Customize every detail</p>

  <div class="adm-tabs">
    <button class="adm-tab active" onclick="switchTab('letter',this)">ğŸ’Œ Letter</button>
    <button class="adm-tab" onclick="switchTab('photos',this)">ğŸ“¸ Photos</button>
    <button class="adm-tab" onclick="switchTab('settings',this)">âš™ï¸ Settings</button>
  </div>

  <!-- Letter tab -->
  <div class="adm-panel active" id="tab-letter">
    <div class="fg"><label>Greeting</label><input type="text" id="aGr"></div>
    <div class="fg"><label>Your Love Letter (separate paragraphs with blank lines)</label><textarea id="aBd" style="min-height:400px"></textarea><p style="font-family:'Patrick Hand',cursive;font-size:.8rem;color:var(--text-light);margin-top:6px">ğŸ’¡ Each paragraph gets its own card with a photo collage above it. More paragraphs = longer scrapbook!</p></div>
    <div class="fg"><label>Sign-off</label><input type="text" id="aSo"></div>
    <div class="fg"><label>Birthday Date</label><input type="text" id="aDt"></div>
  </div>

  <!-- Photos tab -->
  <div class="adm-panel" id="tab-photos">
    <p style="font-family:'Patrick Hand',cursive;color:var(--text-med);margin-bottom:14px;font-size:.95rem">Upload photos and add captions. Photos appear as polaroids in the scrapbook.</p>
    <div class="photo-grid" id="photoGrid"></div>
    <button class="photo-add-btn" onclick="addPhotoSlot()" style="margin-top:14px">+ Add Another Photo</button>
  </div>

  <!-- Settings tab -->
  <div class="adm-panel" id="tab-settings">
    <div class="fg"><label>Visitor Password</label><input type="text" id="aVP"></div>
    <div class="fg"><label>Admin Password</label><input type="text" id="aAP"></div>
    <div class="fg"><label>Gemini API Key (for Birthday Journey)</label><input type="text" id="aGK" placeholder="AIza..."><p style="font-family:'Patrick Hand',cursive;font-size:.8rem;color:var(--text-light);margin-top:4px">ğŸ”‘ Get yours free at <a href="https://aistudio.google.com/apikey" target="_blank" style="color:var(--deep-rose)">aistudio.google.com/apikey</a></p></div>
  </div>

  <div class="aa">
    <button class="sbtn" onclick="saveLetter()">ğŸ’¾ Save All</button>
    <button class="pbtn" onclick="previewLetter()">ğŸ‘ Preview</button>
    <button class="pbtn" onclick="exportConfig()" style="background:var(--gold);color:white;border-color:var(--gold)">ğŸ“¦ Export Config</button>
    <button class="bbtn" onclick="restart()">â† Back</button>
  </div>
  <p class="sfb" id="sFb">Saved with love! ğŸ’•</p>
  <textarea id="exportOutput" style="display:none;width:100%;height:300px;margin-top:16px;font-family:monospace;font-size:12px;padding:12px;border-radius:8px;border:2px solid var(--blush)"></textarea>
</div></div>
<div class="m-ov" id="aM"><div class="modal"><h3>ğŸ” Admin Login</h3><p>Enter admin password</p><input type="password" id="aPIn" placeholder="Password" autocomplete="off"><button class="mbtn" onclick="tryAdm()">Login</button><button class="mcanc" onclick="clAdm()">Cancel</button><p class="er" id="aErr">Wrong password!</p></div></div>
<span class="adm-lk" onclick="opAdm()">admin</span>

<script>
const DEF_PHOTOS=[
  {grad:'linear-gradient(135deg,#fce4ec,#f8bbd0,#f48fb1)',icon:'ğŸ“¸',cap:'Our first photo together',img:'/images/photo1.jpg'},
  {grad:'linear-gradient(135deg,#fff3e0,#ffe0b2,#ffcc80)',icon:'ğŸŒ…',cap:'that perfect sunset with you',img:'/images/photo2.jpg'},
  {grad:'linear-gradient(135deg,#e8f5e9,#c8e6c9,#a5d6a7)',icon:'ğŸŒ¿',cap:'our little escape',img:'/images/photo3.jpg'},
  {grad:'linear-gradient(135deg,#e3f2fd,#bbdefb,#90caf9)',icon:'ğŸ’™',cap:'My happy Place',img:'/images/photo4.jpg'},
  {grad:'linear-gradient(135deg,#f3e5f5,#e1bee7,#ce93d8)',icon:'ğŸ¦‹',cap:'You looked stunning',img:'/images/photo5.jpg'},
  {grad:'linear-gradient(135deg,#fce4ec,#ffcdd2,#ef9a9a)',icon:'ğŸŒ¸',cap:'Chill day with Riyu',img:'/images/photo6.jpg'},
  {grad:'linear-gradient(135deg,#fff8e1,#ffecb3,#ffe082)',icon:'âœ¨',cap:'My Home',img:'/images/photo7.jpg'},
  {grad:'linear-gradient(135deg,#e0f2f1,#b2dfdb,#80cbc4)',icon:'ğŸƒ',cap:'Forever Dance Partner',img:'/images/photo8.jpg'},
  {grad:'linear-gradient(135deg,#ffe4e6,#fecdd3,#fda4af)',icon:'ğŸ’•',cap:'Cutest love bomb',img:'/images/photo9.jpg'},
  {grad:'linear-gradient(135deg,#fdf2f8,#fbcfe8,#f9a8d4)',icon:'ğŸ’‹',cap:'Fav Kiss',img:'/images/photo10.jpg'},
];
const DEF={
  visitorPassword:"iloveyouzyadaa",
  adminPassword:"admin123",
  geminiKey:"",
  greeting:"My Dearest Riyudi piyudi, Patootie,",
  letterBody:`Happy 25th Birthday Riyudi! ğŸ‚

Seriously, 25? Time kitna fast nikal raha h. On your special day, I want you to know that you are my everything - my best friend, my soulmate, my forever person. You make the ordinary extraordinary, and I fall in love with you a little more each day.

Pehli baar jab mile the, bas ek second mein itna comfortable feel hua tha jaise ghar aa gaya hoon. Explain nahi kar paata aaj bhi, bas dil mein kuch click ho gaya. Tab se tujhe dekh ke, baat kar ke, itna zyada pyaar karne laga hoon ki bol bhi nahi paata properly. Jaise woh gaana hai na, "Pehli nazar mein kaisa jaadu kar diya" exactly waisa hi laga tha us din. I love you bohot zyadaa. Every day with you feels like the most beautiful dream I never want to wake up from. Your smile is my sunrise, your laugh is my favorite melody, and your love is the greatest gift life has ever given me.

Teri caring nature, tera chhoti chhoti cheezon mein bhi itna dhyan rakhna, drama karna. Aur teri awaaz, woh sweet wali, jo sirf mere saath baat karte time aati hai. Wo sun ke hi sab theek lag jaata hai. Favourite hai tu meri. I love the way your eyes light up when you're excited, the way you care so deeply about the people around you and your craft, and the way you make even the simplest moments feel magical. Jab tu tension leti hai silly silly baaton ki, woh bhi cute lagta hai bohot. Aur haan, tu sundar bhi hai, bilkul naturally, andar se aur baahar se, poori poori, wo bhi sabse zyada. Sabse sundar. Meri bhondudi.

Hum dono ke beech thodi si shanti rehti h aur thode, ekdum thode jhagde bhi hote h ğŸ˜…. Par yeh bhi accha lagta hai, kyuki har baat ke baad aur close feel hota hai. Tu meri peace hai, best friend hai meri, mujhe toh sabse zyada pasand hai tu aur teri sabse zyada care karta hu. I promise to keep making you laugh, to hold your hand through every storm, and to love you with everything I have, today and always.

Promise kar raha hoon, life bhar tera khayal rakhunga. Love karunga hamesha, tere sapne poore karne mein saath dunga. Tough days aayenge toh bhi side by side rahunga. Jhagde honge, par pyaar kabhi kam nahi hoga. Har birthday aage bhi aise hi extra special banane ki koshish karunga, taaki tu yaad rakhe ki tu kitni important hai mere liye and Thank you for being you. Thank you for choosing me. Thank you for every little moment that we've shared together, I treasure each one more than you'll ever know.

Happy 25th again, Riyudi piyudi, patootie. Tu meri life ka best part hai. You deserve the whole world, and I'll spend every day trying to give it to you. ğŸŒ¹`,
  signOff:"Love you, har din thoda zyada. Forever yours, Shivi potato ğŸ’•",
  birthdayDate:"Happy Birthday, Riyu ğŸ‚âœ¨",
  photos:DEF_PHOTOS
};
let C;try{const s=localStorage.getItem('ll7');C=s?{...DEF,...JSON.parse(s)}:{...DEF};if(!C.photos)C.photos=DEF_PHOTOS}catch{C={...DEF}}
function saveC(){localStorage.setItem('ll7',JSON.stringify(C))}

function getPhotos(){return C.photos&&C.photos.length?C.photos:DEF_PHOTOS}

const TAPE=['rgba(200,225,180,.55)','rgba(255,210,170,.55)','rgba(200,210,240,.55)','rgba(245,195,210,.55)','rgba(230,220,180,.55)'];
const STICKERS=['ğŸŒ¸','ğŸ’•','âœ¨','ğŸ¦‹','ğŸ’«','ğŸŒ¹','ğŸŒº','ğŸ’–','ğŸ€','ğŸŒ·','â˜ï¸','ğŸ°'];
const STICKY_CLS=['sticky-yellow','sticky-pink','sticky-blue','sticky-green'];
const PIN_COLORS=['#d4564a','#c9a84c','#5b8c5a','#5577a5','#9b6b9e'];

// Seeded random for consistent layouts
let seed=42;function srand(s){seed=s}function rand(){seed=(seed*16807+0)%2147483647;return(seed-1)/2147483646}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CANVAS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const bgCv=document.getElementById('bgCanvas'),bgX=bgCv.getContext('2d');
const fxCv=document.getElementById('fxCanvas'),fxX=fxCv.getContext('2d');
const lfxCv=document.getElementById('letterFxCanvas'),lfxX=lfxCv.getContext('2d');
function resize(){bgCv.width=fxCv.width=lfxCv.width=innerWidth;bgCv.height=fxCv.height=lfxCv.height=innerHeight}
resize();addEventListener('resize',resize);
const dots=[];for(let i=0;i<50;i++)dots.push({x:Math.random()*innerWidth,y:Math.random()*innerHeight,r:1.5+Math.random()*3,vx:(Math.random()-.5)*.25,vy:-.12-Math.random()*.3,a:Math.random(),col:['#f8d7d4','#f0b8b4','#fce4ec','#e8c9a0','#ffcdd2','#e8a0a0'][~~(Math.random()*6)],pulse:Math.random()*Math.PI*2});
function drawBg(){bgX.clearRect(0,0,bgCv.width,bgCv.height);for(const d of dots){d.x+=d.vx;d.y+=d.vy;d.pulse+=.02;if(d.y<-10){d.y=bgCv.height+10;d.x=Math.random()*bgCv.width}if(d.x<-10)d.x=bgCv.width+10;if(d.x>bgCv.width+10)d.x=-10;bgX.beginPath();bgX.arc(d.x,d.y,d.r,0,Math.PI*2);bgX.fillStyle=d.col;bgX.globalAlpha=(.3+Math.sin(d.pulse)*.3)*d.a;bgX.fill()}bgX.globalAlpha=1}
let rockets=[],sparks=[];
function launchFW(){for(let i=0;i<7;i++)setTimeout(()=>rockets.push({x:innerWidth*.15+Math.random()*innerWidth*.7,y:innerHeight,ty:innerHeight*.1+Math.random()*innerHeight*.3,vy:-8-Math.random()*4,col:['#f5c6c2','#e8a0a0','#d4a574','#c97878','#fce4ec','#f8bbd0','#e1bee7','#ffcdd2','#ffe0b2'][~~(Math.random()*9)]}),i*350)}
function explode(x,y,col){for(let i=0;i<55;i++){const a=Math.random()*Math.PI*2,sp=1+Math.random()*5;sparks.push({x,y,vx:Math.cos(a)*sp,vy:Math.sin(a)*sp,life:1,decay:.008+Math.random()*.012,r:1.5+Math.random()*2.5,col:Math.random()>.7?'#ffe0b2':col,gravity:.04+Math.random()*.02,trail:[]})}}
function drawFx(){fxX.clearRect(0,0,fxCv.width,fxCv.height);for(let i=rockets.length-1;i>=0;i--){const r=rockets[i];r.y+=r.vy;r.vy+=.12;fxX.beginPath();fxX.arc(r.x,r.y,2.5,0,Math.PI*2);fxX.fillStyle=r.col;fxX.globalAlpha=.9;fxX.fill();if(r.y<=r.ty||r.vy>=0){explode(r.x,r.y,r.col);rockets.splice(i,1)}}for(let i=sparks.length-1;i>=0;i--){const s=sparks[i];s.trail.push({x:s.x,y:s.y,a:s.life});if(s.trail.length>6)s.trail.shift();s.x+=s.vx;s.y+=s.vy;s.vy+=s.gravity;s.vx*=.99;s.life-=s.decay;for(let t=0;t<s.trail.length;t++){const tr=s.trail[t];fxX.beginPath();fxX.arc(tr.x,tr.y,s.r*(t/s.trail.length)*.6,0,Math.PI*2);fxX.fillStyle=s.col;fxX.globalAlpha=tr.a*.25*(t/s.trail.length);fxX.fill()}fxX.beginPath();fxX.arc(s.x,s.y,s.r,0,Math.PI*2);fxX.fillStyle=s.col;fxX.globalAlpha=s.life;fxX.fill();if(s.life<=0)sparks.splice(i,1)}fxX.globalAlpha=1}
let clickH=[];
function drawCH(){lfxX.clearRect(0,0,lfxCv.width,lfxCv.height);for(let i=clickH.length-1;i>=0;i--){const h=clickH[i];h.x+=h.vx;h.y+=h.vy;h.vy+=.06;h.life-=h.decay;lfxX.save();lfxX.globalAlpha=h.life;lfxX.font=h.size+'px serif';lfxX.fillText('\u2665',h.x,h.y);lfxX.restore();if(h.life<=0)clickH.splice(i,1)}}
const hCv=document.getElementById('heartCanvas'),hX=hCv.getContext('2d');let heartP=[],heartOn=false;
function heartShape(t){return{x:16*Math.pow(Math.sin(t),3),y:-(13*Math.cos(t)-5*Math.cos(2*t)-2*Math.cos(3*t)-Math.cos(4*t))}}
function initHP(){heartP=[];const cols=['#f5c6c2','#e8a0a0','#d4a574','#c97878','#fce4ec','#f8bbd0','#ffcdd2'];for(let i=0;i<200;i++){const t=Math.random()*Math.PI*2,h=heartShape(t),sc=8;heartP.push({tx:200+h.x*sc,ty:160+h.y*sc,x:200+Math.random()*400-200,y:350+Math.random()*100,vx:0,vy:0,r:1.5+Math.random()*2.5,col:cols[~~(Math.random()*cols.length)],delay:Math.random()*2,started:false,arrived:false})}heartOn=true}
function drawHP(time){if(!heartOn)return;hX.clearRect(0,0,400,350);for(const p of heartP){if(!p.started){p.delay-=.016;if(p.delay<=0)p.started=true;continue}const dx=p.tx-p.x,dy=p.ty-p.y;p.vx+=dx*.03;p.vy+=dy*.03;p.vx*=.88;p.vy*=.88;p.x+=p.vx;p.y+=p.vy;if(Math.abs(dx)<1&&Math.abs(dy)<1)p.arrived=true;const ox=p.arrived?Math.sin(time*.002+p.tx)*.8:0,oy=p.arrived?Math.cos(time*.0015+p.ty)*.8:0;hX.beginPath();hX.arc(p.x+ox,p.y+oy,p.r,0,Math.PI*2);hX.fillStyle=p.col;hX.globalAlpha=p.started?.85:0;hX.fill();hX.beginPath();hX.arc(p.x+ox,p.y+oy,p.r*3,0,Math.PI*2);hX.fillStyle=p.col;hX.globalAlpha=.08;hX.fill()}hX.globalAlpha=1}
function loop(t){drawBg();drawFx();drawCH();drawHP(t);requestAnimationFrame(loop)}loop(0);
let lastT=0;const hts=['ğŸ’•','ğŸ’—','â™¥','âœ¿','ğŸ’–','ğŸŒ¸'];
function onMv(e){const now=Date.now();if(now-lastT<90)return;lastT=now;const x=e.clientX||(e.touches&&e.touches[0]&&e.touches[0].clientX);const y=e.clientY||(e.touches&&e.touches[0]&&e.touches[0].clientY);if(!x)return;const h=document.createElement('div');h.className='trail-heart';h.textContent=hts[~~(Math.random()*hts.length)];h.style.cssText='left:'+(x-7)+'px;top:'+(y-7)+'px;font-size:'+(10+Math.random()*8)+'px';document.body.appendChild(h);setTimeout(()=>h.remove(),1000)}
document.addEventListener('mousemove',onMv);document.addEventListener('touchmove',onMv,{passive:true});
const sbSt=document.createElement('style');sbSt.textContent='@keyframes sb{0%{transform:translate(0,0) scale(1);opacity:1}100%{transform:translate(var(--sx),var(--sy)) scale(0);opacity:0}}';document.head.appendChild(sbSt);
function sparkle(cx,cy,n){const cols=['#f5c6c2','#e8a0a0','#d4a574','#c97878','#fce4ec','#ffe0b2','#ffcdd2','#f8bbd0'];for(let i=0;i<n;i++){const s=document.createElement('div');const a=Math.random()*Math.PI*2,d=30+Math.random()*120,sz=3+Math.random()*7;s.style.cssText='position:fixed;width:'+sz+'px;height:'+sz+'px;border-radius:50%;left:'+cx+'px;top:'+cy+'px;z-index:101;pointer-events:none;background:'+cols[~~(Math.random()*cols.length)]+';box-shadow:0 0 '+sz*2+'px '+cols[~~(Math.random()*cols.length)]+';animation:sb .8s cubic-bezier(.16,1,.3,1) forwards;--sx:'+Math.cos(a)*d+'px;--sy:'+Math.sin(a)*d+'px';document.body.appendChild(s);setTimeout(()=>s.remove(),900)}}

function show(id){document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active','s-enter'));const el=document.getElementById(id);el.classList.add('active');void el.offsetWidth;el.classList.add('s-enter');window.scrollTo(0,0)}
function tryUnlock(){const v=document.getElementById('pwIn').value;if(v.toLowerCase().trim()===C.visitorPassword.toLowerCase().trim()){sparkle(innerWidth/2,innerHeight/2,40);setTimeout(()=>{resetEnv();show('S_env')},500)}else{const e=document.getElementById('pwErr');e.classList.add('show','shake');document.getElementById('pwIn').value='';setTimeout(()=>e.classList.remove('show','shake'),2200)}}

let eS=0;function resetEnv(){eS=0;document.getElementById('eFl').classList.remove('open');document.getElementById('eSe').classList.remove('burst');document.getElementById('ePk').classList.remove('risen');document.getElementById('env3d').classList.remove('of','lo');document.getElementById('envPr').textContent='Riyu, tap to open your letter \uD83D\uDC8C';document.getElementById('envH').textContent='';document.getElementById('envH').classList.remove('show')}
function envClick(){const cx=innerWidth/2,cy=innerHeight/2;if(eS===0){document.getElementById('eSe').classList.add('burst');sparkle(cx,cy,25);setTimeout(()=>{document.getElementById('eFl').classList.add('open');document.getElementById('env3d').classList.add('of')},300);document.getElementById('envPr').textContent='Your letter is inside...';const h=document.getElementById('envH');h.textContent='tap again to pull it out';h.classList.add('show');eS=1}else if(eS===1){document.getElementById('ePk').classList.add('risen');document.getElementById('env3d').classList.add('lo');sparkle(cx,cy-80,20);document.getElementById('envPr').textContent='There it is! \u2728';document.getElementById('envH').textContent='one more tap...';eS=2}else{resetFold();show('S_uf')}}
let fS=0;function resetFold(){fS=0;document.getElementById('oT').classList.remove('uf');document.getElementById('oSl').classList.remove('burst');document.getElementById('fPr').textContent='Riyu, tap to unfold your letter \u2728';document.getElementById('fH').textContent='tap anywhere';document.getElementById('fH').classList.add('show')}
function ufClick(){const cx=innerWidth/2,cy=innerHeight/2;if(fS===0){document.getElementById('oSl').classList.add('burst');sparkle(cx,cy-60,22);setTimeout(()=>document.getElementById('oT').classList.add('uf'),350);document.getElementById('fPr').textContent='Read your letter, Riyu \uD83D\uDC95';document.getElementById('fH').textContent='tap to reveal';fS=1}else{show('S_sb');renderScrapbook();setTimeout(()=>launchFW(),400)}}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SCRAPBOOK BUILDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let heartFinaleStarted=false;

function renderPhotoInner(ph){
  if(ph.img){
    return '<div class="ph-img"><img src="'+ph.img+'" style="width:100%;height:100%;object-fit:cover;display:block"></div>';
  }
  return '<div class="ph-img"><div class="ph-grad" style="background:'+ph.grad+'"></div><div class="ph-icon">'+ph.icon+'</div></div>';
}

function makePolaroid(photoIdx,size,rot,attachment){
  const photos=getPhotos();
  const ph=photos[photoIdx%photos.length];
  const sz=size||'m';
  const el=document.createElement('div');
  el.className='polaroid sz-'+sz;
  el.style.transform='rotate('+rot+'deg)';
  el.style.cursor='zoom-in';

  // Hover: straighten
  const hr=rot;
  el.addEventListener('mouseenter',()=>el.style.transform='scale(1.06) rotate(0deg)');
  el.addEventListener('mouseleave',()=>el.style.transform='rotate('+hr+'deg)');

  // Click: open lightbox
  const galleryIdx=lbGallery.length;
  lbGallery.push(ph);
  el.addEventListener('click',(e)=>openLB(galleryIdx,e));

  el.innerHTML='<div class="p-inner">'+renderPhotoInner(ph)+'</div><div class="polaroid-cap">'+ph.cap+'</div>';

  // Attachment type
  if(attachment==='tape'){
    const t=document.createElement('div');t.className='washi';
    t.style.background=TAPE[~~(rand()*TAPE.length)];
    t.style.transform='rotate('+(rand()*30-15)+'deg)';
    t.style.top='-8px';t.style.left=(rand()*30+15)+'%';
    t.style.width=(55+rand()*35)+'px';
    el.appendChild(t);
  }else if(attachment==='pin'){
    const p=document.createElement('div');p.className='pushpin';
    p.style.background=PIN_COLORS[~~(rand()*PIN_COLORS.length)];
    p.style.top='-6px';p.style.left='50%';p.style.transform='translateX(-50%)';
    el.appendChild(p);
  }else if(attachment==='clip'){
    const c=document.createElement('div');c.className='paperclip';
    c.style.top='-18px';c.style.right='12px';
    c.style.transform='rotate('+(rand()*16-8)+'deg)';
    el.appendChild(c);
  }else{
    // double tape
    const t1=document.createElement('div');t1.className='washi';
    t1.style.background=TAPE[~~(rand()*TAPE.length)];
    t1.style.transform='rotate('+(rand()*25-12)+'deg)';
    t1.style.top='-6px';t1.style.left='-10px';
    t1.style.width='60px';
    el.appendChild(t1);
    const t2=document.createElement('div');t2.className='washi';
    t2.style.background=TAPE[~~(rand()*TAPE.length)];
    t2.style.transform='rotate('+(rand()*25-12)+'deg)';
    t2.style.bottom='-6px';t2.style.right='-8px';t2.style.top='auto';
    t2.style.width='55px';
    el.appendChild(t2);
  }
  return el;
}

function addSticker(parent,emoji,x,y,size,rot){
  const s=document.createElement('div');s.className='sticker';
  s.textContent=emoji;
  s.style.cssText='left:'+x+'%;top:'+y+'px;font-size:'+size+'rem;--rot:'+rot+'deg;animation-delay:'+(rand()*.5)+'s';
  parent.appendChild(s);
}

function addStickyNote(parent,text,x,y,rot,cls){
  const s=document.createElement('div');s.className='sticky-note '+cls;
  s.textContent=text;
  s.style.cssText='left:'+x+'%;top:'+y+'px;transform:rotate('+rot+'deg)';
  parent.appendChild(s);
}

// Layout presets for collage sections (positions as % left, px top, size, rotation, attachment)
const LAYOUTS=[
  // Layout A: 3 photos scattered wide
  [{l:2,t:0,sz:'l',r:-4,a:'tape'},{l:52,t:30,sz:'m',r:6,a:'pin'},{l:28,t:160,sz:'s',r:-8,a:'clip'}],
  // Layout B: 2 overlapping, one offset
  [{l:8,t:10,sz:'m',r:5,a:'tape'},{l:30,t:0,sz:'l',r:-3,a:'pin'},{l:65,t:50,sz:'s',r:10,a:'tape'}],
  // Layout C: Stack left, one right
  [{l:5,t:0,sz:'m',r:-6,a:'clip'},{l:15,t:100,sz:'s',r:4,a:'tape'},{l:55,t:20,sz:'l',r:-2,a:'tape'}],
  // Layout D: Fan spread
  [{l:10,t:20,sz:'m',r:-12,a:'pin'},{l:32,t:0,sz:'l',r:2,a:'tape'},{l:60,t:40,sz:'m',r:8,a:'clip'}],
  // Layout E: Tight cluster
  [{l:15,t:0,sz:'l',r:-3,a:'tape'},{l:45,t:10,sz:'m',r:7,a:'pin'},{l:35,t:130,sz:'s',r:-10,a:'tape'}],
];

function renderScrapbook(){
  srand(42);heartOn=false;heartFinaleStarted=false;lbGallery=[];

  // Title
  const tEl=document.getElementById('sbTitle');tEl.innerHTML='';
  'Happy 25th, Riyudi!'.split('').forEach((ch,i)=>{
    if(ch===' '){tEl.innerHTML+='<span class="space"></span>';return}
    const span=document.createElement('span');span.className='char';span.textContent=ch;
    span.style.animationDelay=(.3+i*.07)+'s';
    span.style.color='hsl('+(340+i*8)+',55%,55%)';
    tEl.appendChild(span);
  });
  document.getElementById('sbDate').textContent=C.birthdayDate;
  document.getElementById('sbSignOff').textContent=C.signOff;
  document.getElementById('sbSign').classList.remove('vis');
  buildStringLights();

  const page=document.getElementById('sbPage');page.innerHTML='';
  const paras=C.letterBody.split('\n\n');

  // Greeting
  const grDiv=document.createElement('div');grDiv.className='sb-greeting';
  grDiv.innerHTML='<span class="sb-greeting-text" id="grTyped"></span><span class="gr-cursor"></span><svg class="doodle-line" id="grLine" viewBox="0 0 200 12" width="180"><path d="M10 8 Q50 2 100 8 Q150 14 190 6"/></svg>';
  page.appendChild(grDiv);

  let photoCounter=0;

  paras.forEach((txt,i)=>{
    // Photo collage
    const collage=document.createElement('div');collage.className='collage';
    const layout=LAYOUTS[i%LAYOUTS.length];
    const isMobile=innerWidth<700;

    // Compute needed height
    let maxBottom=0;
    layout.forEach((pos,j)=>{
      const szMap={s:isMobile?90:120,m:isMobile?120:160,l:isMobile?155:200};
      const w=szMap[pos.sz];
      const totalH=pos.t+(w*1.5)+40;// photo height + caption (1.5x for portrait photos)
      if(totalH>maxBottom)maxBottom=totalH;

      const pol=makePolaroid(photoCounter,pos.sz,pos.r+(rand()*6-3),pos.a);
      pol.style.left=isMobile?Math.min(pos.l,100-((w/innerWidth)*100)-5)+'%':pos.l+'%';
      pol.style.top=(pos.t+(rand()*20-10))+'px';
      pol.style.zIndex=5+j;
      collage.appendChild(pol);
      photoCounter++;
    });

    collage.style.minHeight=(maxBottom+60)+'px';// extra padding for portrait photos

    // Random stickers on collage
    if(rand()>.35){
      addSticker(collage,STICKERS[~~(rand()*STICKERS.length)],
        60+rand()*30, rand()*maxBottom*.6, 1.2+rand()*.8, rand()*25-12);
    }

    page.appendChild(collage);

    // Text block
    const tb=document.createElement('div');tb.className='sb-text-block';
    tb.innerHTML='<p>'+txt+'</p>';

    // Randomly add a sticky note beside some text blocks
    if(rand()>.5&&i<paras.length-1){
      const notes=['so true!','<3 <3 <3','this part\nmakes me\ncry every time','â™¡','i love us','Riyu = \nmy world','best part!','happy bday\nRiyu!!'];
      const sn=document.createElement('div');sn.className='sticky-note '+STICKY_CLS[~~(rand()*STICKY_CLS.length)];
      sn.textContent=notes[~~(rand()*notes.length)];
      sn.style.cssText='position:absolute;right:-'+(isMobile?0:60)+'px;top:'+(10+rand()*30)+'px;transform:rotate('+(rand()*12-6)+'deg);z-index:10';
      tb.appendChild(sn);
    }

    page.appendChild(tb);

    // Divider doodle between sections (not after last)
    if(i<paras.length-1){
      const div=document.createElement('div');div.className='sb-divider';
      const divPatterns=['â™¡ â™¡ â™¡','~ âœ¿ ~','* * *','â™¡ ~ â™¡','âœ¿ â™¡ âœ¿'];
      div.textContent=divPatterns[~~(rand()*divPatterns.length)];
      page.appendChild(div);
    }
  });

  setTimeout(()=>{scatterPageDecos();setupObs()},100);
}

function scatterPageDecos(){
  // Remove old decos
  document.querySelectorAll('.page-deco,.margin-note').forEach(d=>{if(d.closest('.sb-page,.sb-bg'))d.remove()});
  
  const bg=document.querySelector('.sb-bg');
  const pageW=Math.min(820,innerWidth);
  const isMobile=innerWidth<700;
  
  // Icon pool â€” the scrapbook aesthetic icons
  const icons=['ğŸ“¸','ğŸŒ…','ğŸŒ¿','ğŸ’™','ğŸ¦‹','ğŸŒ¸','âœ¨','ğŸƒ','ğŸŒ¹','ğŸŒº','ğŸ’«','ğŸ€','â˜ï¸','ğŸ°','ğŸ’•','âœ¿','ğŸŒ·','ğŸ’–','ğŸ‚','ğŸ§'];
  
  // Margin doodles
  const marginNotes=['â™¡','xoxo','us','âœ¿','forever','always','â™¡â™¡','Riyu!','mine','luv','â˜†','yay!','â™ªâ™«','R+me'];
  
  // Scatter icons along left and right margins at intervals
  const totalH=bg.scrollHeight||3000;
  const spacing=isMobile?220:180;
  const decos=[];
  
  for(let y=150;y<totalH-200;y+=spacing){
    // Alternate sides with randomness
    const side=Math.random()>.5?'left':'right';
    const icon=icons[~~(Math.random()*icons.length)];
    const size=(1+Math.random()*1.2).toFixed(1);
    const opacity=(.2+Math.random()*.25).toFixed(2);
    const rot=(Math.random()*30-15).toFixed(0);
    const dur=(4+Math.random()*4).toFixed(1);
    const delay=(Math.random()*3).toFixed(1);
    const yOff=(Math.random()*60-30).toFixed(0);
    
    let xPos;
    if(isMobile){
      xPos=side==='left'?(2+Math.random()*8):(88+Math.random()*8);
    } else {
      // Place in margins outside the main content area
      const margin=(pageW<innerWidth)?(innerWidth-pageW)/2:0;
      if(side==='left'){
        xPos=Math.max(1,(margin-60+Math.random()*50)/innerWidth*100);
      } else {
        xPos=Math.min(96,(innerWidth-margin+10+Math.random()*40)/innerWidth*100);
      }
    }
    
    decos.push({icon,x:xPos,y:y+parseInt(yOff),size,opacity,rot,dur,delay});
  }
  
  // Also scatter some in between content â€” smaller, more subtle
  for(let y=300;y<totalH-300;y+=spacing*1.8){
    if(Math.random()>.55)continue;
    const icon=icons[~~(Math.random()*icons.length)];
    const centerX=30+Math.random()*40;
    decos.push({
      icon, x:centerX, y:y+Math.random()*80,
      size:(.8+Math.random()*.6).toFixed(1),
      opacity:(.12+Math.random()*.15).toFixed(2),
      rot:(Math.random()*20-10).toFixed(0),
      dur:(5+Math.random()*4).toFixed(1),
      delay:(Math.random()*2).toFixed(1)
    });
  }
  
  // Create DOM elements
  decos.forEach(d=>{
    const el=document.createElement('div');
    el.className='page-deco';
    el.style.cssText='left:'+d.x+'%;top:'+d.y+'px;--deco-size:'+d.size+'rem;--deco-opacity:'+d.opacity+';--deco-rot:'+d.rot+'deg;--deco-dur:'+d.dur+'s;--deco-delay:'+d.delay+'s';
    el.innerHTML='<div class="page-deco-inner">'+d.icon+'</div>';
    bg.appendChild(el);
  });
  
  // Margin handwritten notes â€” sparse
  for(let y=400;y<totalH-300;y+=spacing*2.5){
    if(Math.random()>.5)continue;
    const note=document.createElement('div');
    note.className='margin-note';
    const text=marginNotes[~~(Math.random()*marginNotes.length)];
    note.textContent=text;
    const side=Math.random()>.5;
    let xPos;
    if(isMobile){
      xPos=side?'2%':'85%';
    } else {
      const margin=(pageW<innerWidth)?(innerWidth-pageW)/2:0;
      xPos=side?Math.max(1,(margin-70+Math.random()*30)/innerWidth*100)+'%':Math.min(95,(innerWidth-margin+15+Math.random()*30)/innerWidth*100)+'%';
    }
    note.style.cssText='left:'+xPos+';top:'+(y+Math.random()*40)+'px;--note-rot:'+(Math.random()*16-8)+'deg;font-size:'+(0.75+Math.random()*0.4)+'rem';
    bg.appendChild(note);
  }
}

function buildStringLights(){
  const c=document.getElementById('sL');c.querySelectorAll('.sl-bulb').forEach(b=>b.remove());
  const cols=['#f48fb1','#ffe082','#a5d6a7','#90caf9','#ce93d8','#ef9a9a','#80cbc4','#ffcc80'];
  for(let i=0;i<12;i++){const b=document.createElement('div');b.className='sl-bulb';b.style.left=(8+i*(84/11))+'%';b.style.background=cols[i%cols.length];b.style.color=cols[i%cols.length];b.style.animationDelay=(i*.3)+'s';c.appendChild(b)}
}

function setupObs(){
  const obs=new IntersectionObserver(entries=>{entries.forEach(e=>{if(e.isIntersecting)e.target.classList.add('vis')})},{threshold:.1});
  document.querySelectorAll('.collage,.sb-text-block,.sb-greeting,.page-deco,.margin-note').forEach(el=>obs.observe(el));
  obs.observe(document.getElementById('sbSign'));

  const grObs=new IntersectionObserver(entries=>{entries.forEach(e=>{if(e.isIntersecting&&!grObs._done){grObs._done=true;startGrType()}})},{threshold:.3});
  grObs._done=false;
  const gr=document.querySelector('.sb-greeting');if(gr)grObs.observe(gr);

  const hObs=new IntersectionObserver(entries=>{entries.forEach(e=>{if(e.isIntersecting&&!heartFinaleStarted){heartFinaleStarted=true;initHP()}})},{threshold:.2});
  hObs.observe(document.getElementById('sbFinale'));
}

function startGrType(){
  const el=document.getElementById('grTyped');if(!el)return;
  const text=C.greeting;let i=0;
  function tick(){if(i<text.length){el.textContent+=text[i];i++;setTimeout(tick,45)}else{const cur=document.querySelector('.gr-cursor');if(cur)cur.style.display='none';const line=document.getElementById('grLine');if(line)line.classList.add('drawn')}}
  tick();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PHOTO LIGHTBOX
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let lbGallery=[], lbIndex=0, lbOpen=false;

function openLB(index,e){
  if(e){e.stopPropagation();e.preventDefault();}
  lbIndex=index;lbOpen=true;
  const ph=lbGallery[lbIndex];
  document.getElementById('lbImg').innerHTML=renderLBImg(ph);
  document.getElementById('lbCap').textContent=ph.cap;
  document.getElementById('lbCounter').textContent=(lbIndex+1)+' / '+lbGallery.length;
  // Slight random tilt for natural feel
  const tilt=(Math.random()*4-2).toFixed(1);
  document.querySelector('.lb-polaroid').style.transform='rotate('+tilt+'deg)';
  const lb=document.getElementById('lightbox');
  lb.classList.add('active');
  const content=lb.querySelector('.lb-content');
  content.style.transition='none';
  content.style.opacity='0';
  content.style.transform='scale(.6) rotate('+(parseFloat(tilt)-5)+'deg) translateY(30px)';
  void content.offsetWidth;
  content.style.transition='';
  void content.offsetWidth;
  content.style.opacity='1';
  content.style.transform='scale(1) rotate(0deg) translateY(0)';
}

function closeLB(e){
  if(e&&(e.target.classList.contains('lb-nav')||e.target.closest('.lb-nav')))return;
  const lb=document.getElementById('lightbox');
  const content=lb.querySelector('.lb-content');
  content.style.opacity='0';
  content.style.transform='scale(.7) translateY(20px)';
  lb.querySelector('.lb-backdrop').style.opacity='0';
  setTimeout(()=>{lb.classList.remove('active');lbOpen=false},350);
}

function navLB(dir,e){
  if(e){e.stopPropagation();e.preventDefault();}
  lbIndex=(lbIndex+dir+lbGallery.length)%lbGallery.length;
  const ph=lbGallery[lbIndex];
  const content=document.querySelector('.lb-content');
  const slideDir=dir>0?'30px':'-30px';
  content.style.transition='opacity .2s, transform .2s';
  content.style.opacity='0';
  content.style.transform='translateX('+slideDir+')';
  setTimeout(()=>{
    document.getElementById('lbImg').innerHTML=renderLBImg(ph);
    document.getElementById('lbCap').textContent=ph.cap;
    document.getElementById('lbCounter').textContent=(lbIndex+1)+' / '+lbGallery.length;
    const tilt=(Math.random()*4-2).toFixed(1);
    document.querySelector('.lb-polaroid').style.transform='rotate('+tilt+'deg)';
    content.style.transition='none';
    content.style.transform='translateX('+(dir>0?'-30px':'30px')+')';
    void content.offsetWidth;
    content.style.transition='opacity .25s, transform .25s cubic-bezier(.16,1,.3,1)';
    content.style.opacity='1';
    content.style.transform='translateX(0)';
  },200);
}

// Keyboard nav for lightbox
document.addEventListener('keydown',e=>{
  if(!lbOpen)return;
  if(e.key==='Escape'||e.key===' ')closeLB();
  if(e.key==='ArrowLeft')navLB(-1);
  if(e.key==='ArrowRight')navLB(1);
});

// Touch swipe for lightbox
let lbTouchX=0;
document.getElementById('lightbox').addEventListener('touchstart',e=>{
  if(!lbOpen)return;lbTouchX=e.touches[0].clientX;
},{passive:true});
document.getElementById('lightbox').addEventListener('touchend',e=>{
  if(!lbOpen)return;
  const dx=e.changedTouches[0].clientX-lbTouchX;
  if(Math.abs(dx)>50){navLB(dx<0?1:-1);e.preventDefault();e.stopPropagation();}
});

// Prevent click hearts when clicking photos
document.addEventListener('click',e=>{
  if(e.target.closest('.polaroid')||e.target.closest('.lightbox'))return;
  if(!document.getElementById('S_sb').classList.contains('active'))return;
  for(let i=0;i<6;i++){const a=Math.random()*Math.PI*2,sp=1.5+Math.random()*3;clickH.push({x:e.clientX,y:e.clientY,vx:Math.cos(a)*sp,vy:Math.sin(a)*sp-2,life:1,decay:.015+Math.random()*.01,size:8+Math.random()*12,col:['#f5c6c2','#e8a0a0','#d4a574','#c97878','#fce4ec'][~~(Math.random()*5)]})}
},{capture:false});

function restart(){show('S_pw');document.getElementById('pwIn').value='';heartOn=false}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderLBImg(ph){
  const el=document.getElementById('lbImg');
  if(ph.img){
    el.classList.add('has-real-img');
    return '<img src="'+ph.img+'">';
  }
  el.classList.remove('has-real-img');
  return '<div class="ph-grad" style="background:'+ph.grad+'"></div><div class="ph-icon">'+ph.icon+'</div>';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ADMIN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function switchTab(id,btn){
  document.querySelectorAll('.adm-tab').forEach(t=>t.classList.remove('active'));
  document.querySelectorAll('.adm-panel').forEach(p=>p.classList.remove('active'));
  btn.classList.add('active');
  document.getElementById('tab-'+id).classList.add('active');
}

function opAdm(){document.getElementById('aM').classList.add('active');document.getElementById('aPIn').value='';document.getElementById('aErr').classList.remove('show');setTimeout(()=>document.getElementById('aPIn').focus(),100)}
function clAdm(){document.getElementById('aM').classList.remove('active')}

function tryAdm(){
  if(document.getElementById('aPIn').value===C.adminPassword){
    clAdm();
    document.getElementById('aVP').value=C.visitorPassword;
    document.getElementById('aAP').value=C.adminPassword;
    document.getElementById('aGK').value=C.geminiKey||'';
    document.getElementById('aGr').value=C.greeting;
    document.getElementById('aBd').value=C.letterBody;
    document.getElementById('aSo').value=C.signOff;
    document.getElementById('aDt').value=C.birthdayDate;
    buildPhotoGrid();
    // Reset to first tab
    document.querySelectorAll('.adm-tab').forEach((t,i)=>{t.classList.toggle('active',i===0)});
    document.querySelectorAll('.adm-panel').forEach((p,i)=>{p.classList.toggle('active',i===0)});
    show('S_adm');
  } else {
    const e=document.getElementById('aErr');e.classList.add('show');
    setTimeout(()=>e.classList.remove('show'),2000);
  }
}

// â”€â”€ Photo grid management â”€â”€
function buildPhotoGrid(){
  const grid=document.getElementById('photoGrid');
  grid.innerHTML='';
  const photos=getPhotos();
  photos.forEach((ph,i)=>grid.appendChild(createPhotoSlot(i,ph)));
}

function createPhotoSlot(index,ph){
  const slot=document.createElement('div');
  slot.className='photo-slot'+(ph.img?' has-img':'');
  slot.dataset.index=index;

  const num=document.createElement('div');
  num.className='photo-slot-num';
  num.textContent='Photo '+(index+1);

  const preview=document.createElement('div');
  preview.className='photo-slot-preview';
  if(ph.img){
    preview.innerHTML='<img src="'+ph.img+'">';
  } else {
    preview.innerHTML='<div class="ph-placeholder">'+ph.icon+'</div>';
  }

  const fileInput=document.createElement('input');
  fileInput.type='file';
  fileInput.accept='image/*';
  fileInput.id='file-'+index;
  fileInput.addEventListener('change',e=>handlePhotoUpload(e,index));

  const uploadBtn=document.createElement('button');
  uploadBtn.className='photo-slot-upload';
  uploadBtn.textContent=ph.img?'ğŸ“· Change Photo':'ğŸ“· Upload Photo';
  uploadBtn.onclick=()=>fileInput.click();

  const capInput=document.createElement('input');
  capInput.type='text';
  capInput.className='photo-slot-cap';
  capInput.value=ph.cap;
  capInput.placeholder='Caption...';
  capInput.dataset.index=index;

  const removeBtn=document.createElement('button');
  removeBtn.className='photo-slot-remove';
  removeBtn.textContent='âœ•';
  removeBtn.onclick=(e)=>{e.stopPropagation();removePhoto(index)};

  slot.appendChild(removeBtn);
  slot.appendChild(num);
  slot.appendChild(preview);
  slot.appendChild(fileInput);
  slot.appendChild(uploadBtn);
  slot.appendChild(capInput);
  return slot;
}

function handlePhotoUpload(e,index){
  const file=e.target.files[0];
  if(!file)return;
  const reader=new FileReader();
  reader.onload=function(ev){
    const photos=getPhotos();
    // Resize image to save localStorage space
    const img=new Image();
    img.onload=function(){
      const canvas=document.createElement('canvas');
      const MAX=800;
      let w=img.width,h=img.height;
      if(w>h){if(w>MAX){h=h*(MAX/w);w=MAX}}else{if(h>MAX){w=w*(MAX/h);h=MAX}}
      canvas.width=w;canvas.height=h;
      const ctx=canvas.getContext('2d');
      ctx.drawImage(img,0,0,w,h);
      const dataUrl=canvas.toDataURL('image/jpeg',0.8);
      if(index<photos.length){
        photos[index].img=dataUrl;
      }
      C.photos=photos;
      buildPhotoGrid();
    };
    img.src=ev.target.result;
  };
  reader.readAsDataURL(file);
}

function removePhoto(index){
  const photos=getPhotos();
  if(photos.length<=1)return;
  photos.splice(index,1);
  C.photos=photos;
  buildPhotoGrid();
}

function addPhotoSlot(){
  const photos=getPhotos();
  const gradients=[
    'linear-gradient(135deg,#fce4ec,#f8bbd0,#f48fb1)',
    'linear-gradient(135deg,#fff3e0,#ffe0b2,#ffcc80)',
    'linear-gradient(135deg,#e8f5e9,#c8e6c9,#a5d6a7)',
    'linear-gradient(135deg,#e3f2fd,#bbdefb,#90caf9)',
    'linear-gradient(135deg,#f3e5f5,#e1bee7,#ce93d8)',
    'linear-gradient(135deg,#fff8e1,#ffecb3,#ffe082)',
  ];
  const icons=['ğŸ“¸','ğŸŒ…','ğŸŒ¿','ğŸ’™','ğŸ¦‹','ğŸŒ¸','âœ¨','ğŸƒ'];
  photos.push({
    grad:gradients[photos.length%gradients.length],
    icon:icons[photos.length%icons.length],
    cap:'new photo',
    img:''
  });
  C.photos=photos;
  buildPhotoGrid();
  // Scroll to new slot
  const grid=document.getElementById('photoGrid');
  grid.lastElementChild.scrollIntoView({behavior:'smooth',block:'center'});
}

function collectPhotoCaptions(){
  const caps=document.querySelectorAll('.photo-slot-cap');
  const photos=getPhotos();
  caps.forEach(input=>{
    const idx=parseInt(input.dataset.index);
    if(idx<photos.length)photos[idx].cap=input.value||photos[idx].cap;
  });
  C.photos=photos;
}

function saveLetter(){
  C.visitorPassword=document.getElementById('aVP').value||C.visitorPassword;
  const newAdmPw=document.getElementById('aAP').value;
  if(newAdmPw)C.adminPassword=newAdmPw;
  C.geminiKey=document.getElementById('aGK').value||'';
  C.greeting=document.getElementById('aGr').value||C.greeting;
  C.letterBody=document.getElementById('aBd').value||C.letterBody;
  C.signOff=document.getElementById('aSo').value||C.signOff;
  C.birthdayDate=document.getElementById('aDt').value||C.birthdayDate;
  collectPhotoCaptions();
  try{saveC()}catch(e){
    // localStorage might be full with images
    alert('Storage full! Try reducing image count or quality.');return;
  }
  const f=document.getElementById('sFb');f.classList.add('show');
  setTimeout(()=>f.classList.remove('show'),2200);
}
function previewLetter(){saveLetter();show('S_sb');renderScrapbook();setTimeout(()=>launchFW(),400)}

// Export config for hardcoding
function exportConfig(){
  saveLetter();
  const exportData = {
    visitorPassword: C.visitorPassword,
    adminPassword: C.adminPassword,
    greeting: C.greeting,
    letterBody: C.letterBody,
    signOff: C.signOff,
    birthdayDate: C.birthdayDate,
    photos: C.photos.map((p,i) => ({
      filename: 'photo'+(i+1)+'.jpg',
      caption: p.cap,
      hasImage: !!p.img,
      // Include base64 for download
      base64: p.img || null
    }))
  };
  const output = document.getElementById('exportOutput');
  output.style.display = 'block';
  output.value = '=== COPY THIS CONFIG ===\n\n' + JSON.stringify({
    visitorPassword: exportData.visitorPassword,
    greeting: exportData.greeting,
    letterBody: exportData.letterBody,
    signOff: exportData.signOff,
    birthdayDate: exportData.birthdayDate,
    photos: exportData.photos.map(p => ({cap: p.caption, hasImage: p.hasImage}))
  }, null, 2);
  output.select();

  // Also offer to download images
  if(confirm('Config copied! Do you want to download your photos as a ZIP?\n\n(Click OK to download photos, Cancel to skip)')){
    downloadPhotos();
  }
}

function downloadPhotos(){
  const photos = C.photos.filter(p => p.img);
  if(photos.length === 0){
    alert('No photos uploaded yet!');
    return;
  }
  photos.forEach((p, i) => {
    if(p.img){
      const link = document.createElement('a');
      link.href = p.img;
      link.download = 'photo'+(i+1)+'.jpg';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }
  });
  alert('Downloaded '+photos.length+' photos! Move them to public/images/ folder.');
}

document.getElementById('pwIn').addEventListener('keydown',e=>{if(e.key==='Enter')tryUnlock()});
document.getElementById('aPIn').addEventListener('keydown',e=>{if(e.key==='Enter')tryAdm()});
</script>
</body>
</html>
